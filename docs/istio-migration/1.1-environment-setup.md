# 1.1 ç¯å¢ƒå‡†å¤‡æ“ä½œæ–‡æ¡£

æœ¬æ–‡æ¡£æä¾› Istio ç¯å¢ƒæ­å»ºçš„è¯¦ç»†æ“ä½œæ­¥éª¤ï¼Œç”¨äº Sealos Ingress åˆ° Istio Gateway/VirtualService è¿ç§»ã€‚

## å‰ç½®è¦æ±‚

- Kubernetes é›†ç¾¤ç‰ˆæœ¬ >= 1.27
- kubectl å·²é…ç½®å¹¶èƒ½è®¿é—®é›†ç¾¤
- Helm 3.x å·²å®‰è£…
- é›†ç¾¤èŠ‚ç‚¹èµ„æºå……è¶³ï¼ˆæ¯èŠ‚ç‚¹è‡³å°‘ 4GB å¯ç”¨å†…å­˜ï¼‰

## 1. éƒ¨ç½² Istio åˆ°æµ‹è¯•é›†ç¾¤

### 1.1 ä¸‹è½½å¹¶å®‰è£… Istioctl

```bash
# ä¸‹è½½ Istio 1.20.x (æœ€æ–°ç¨³å®šç‰ˆ)
curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.20.2 sh -

# æ·»åŠ  istioctl åˆ° PATH
cd istio-1.20.2
export PATH=$PWD/bin:$PATH

# éªŒè¯å®‰è£…
istioctl version --remote=false
```

### 1.2 å®‰è£… Istio æ ¸å¿ƒç»„ä»¶

åˆ›å»º Istio é…ç½®æ–‡ä»¶ `istio-install-config.yaml`ï¼š

```yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: sealos-istio
spec:
  # ä½¿ç”¨ç”Ÿäº§é…ç½®æ–‡ä»¶ä½œä¸ºåŸºç¡€
  profile: production
  
  # ç»„ä»¶é…ç½®
  components:
    ingressGateways:
    - name: istio-ingressgateway
      enabled: true
      k8s:
        resources:
          requests:
            cpu: 1000m
            memory: 1024Mi
          limits:
            cpu: 2000m
            memory: 2048Mi
        service:
          type: LoadBalancer
          ports:
          - port: 15021
            targetPort: 15021
            name: status-port
          - port: 80
            targetPort: 8080
            name: http2
          - port: 443
            targetPort: 8443
            name: https
          - port: 31400
            targetPort: 31400
            name: tcp
        hpaSpec:
          minReplicas: 2
          maxReplicas: 10
          metrics:
          - type: Resource
            resource:
              name: cpu
              target:
                type: Utilization
                averageUtilization: 80
    
    pilot:
      enabled: true
      k8s:
        resources:
          requests:
            cpu: 500m
            memory: 2048Mi
        hpaSpec:
          minReplicas: 2
          maxReplicas: 5
  
  # ç½‘æ ¼é…ç½®
  meshConfig:
    accessLogFile: /dev/stdout
    defaultConfig:
      proxyStatsMatcher:
        inclusionRegexps:
        - ".*outlier_detection.*"
        - ".*circuit_breakers.*"
        - ".*_rq_retry.*"
        - ".*_rq_pending.*"
        - ".*_cx_.*"
    extensionProviders:
    - name: prometheus
      prometheus:
        service: prometheus.istio-system.svc.cluster.local
        port: 9090
  
  # å…¨å±€é…ç½®
  values:
    global:
      proxy:
        # å¯ç”¨è‡ªåŠ¨æ³¨å…¥
        autoInject: enabled
        # èµ„æºé™åˆ¶
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 2000m
            memory: 1024Mi
      # å¤šé›†ç¾¤é…ç½®é¢„ç•™
      multiCluster:
        clusterName: sealos-cluster
    telemetry:
      v2:
        prometheus:
          configOverride:
            inboundSidecar:
              disable_host_header_fallback: true
            outboundSidecar:
              disable_host_header_fallback: true
```

æ‰§è¡Œå®‰è£…ï¼š

```bash
# åˆ›å»º istio-system å‘½åç©ºé—´
kubectl create namespace istio-system

# å®‰è£… Istio
istioctl install -f istio-install-config.yaml -y

# ç­‰å¾…æ‰€æœ‰ç»„ä»¶å°±ç»ª
kubectl -n istio-system wait --for=condition=Ready pod --all --timeout=300s

# éªŒè¯å®‰è£…
istioctl verify-install
```

### 1.3 å®‰è£…å¯è§‚æµ‹æ€§ç»„ä»¶ï¼ˆå¯é€‰ä½†æ¨èï¼‰

```bash
# å®‰è£… Prometheus
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/addons/prometheus.yaml

# å®‰è£… Grafana
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/addons/grafana.yaml

# å®‰è£… Kiali
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/addons/kiali.yaml

# å®‰è£… Jaeger
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/addons/jaeger.yaml

# ç­‰å¾…éƒ¨ç½²å®Œæˆ
kubectl -n istio-system rollout status deployment/kiali
kubectl -n istio-system rollout status deployment/prometheus
kubectl -n istio-system rollout status deployment/grafana
```

## 2. é…ç½® Istio å¤šç§Ÿæˆ·æ”¯æŒ

### 2.1 åˆ›å»ºå¤šç§Ÿæˆ· RBAC ç­–ç•¥

åˆ›å»º `istio-multitenancy-rbac.yaml`ï¼š

```yaml
# ä¸ºæ¯ä¸ªç§Ÿæˆ·å‘½åç©ºé—´åˆ›å»º ServiceRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: istio-namespace-gateway-admin
rules:
- apiGroups: ["networking.istio.io"]
  resources: ["virtualservices", "destinationrules", "serviceentries"]
  verbs: ["*"]
- apiGroups: ["networking.istio.io"]
  resources: ["gateways"]
  verbs: ["get", "list", "watch"]  # ç§Ÿæˆ·åªèƒ½æŸ¥çœ‹ Gatewayï¼Œä¸èƒ½ä¿®æ”¹
---
# é™åˆ¶è·¨å‘½åç©ºé—´æµé‡çš„ PeerAuthentication
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: istio-system
spec:
  mtls:
    mode: STRICT
---
# é»˜è®¤æ‹’ç»æ‰€æœ‰è·¨å‘½åç©ºé—´æµé‡çš„ AuthorizationPolicy
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all-cross-namespace
  namespace: istio-system
spec:
  rules:
  - from:
    - source:
        notNamespaces: ["istio-system", "kube-system"]
    to:
    - operation:
        notNamespaces: ["{{ .SourceNamespace }}"]
  action: DENY
```

### 2.2 åˆ›å»ºç§Ÿæˆ·å‘½åç©ºé—´æ¨¡æ¿

åˆ›å»ºè„šæœ¬ `create-tenant-namespace.sh`ï¼š

```bash
#!/bin/bash

TENANT_NAME=$1
NAMESPACE="ns-${TENANT_NAME}"

if [ -z "$TENANT_NAME" ]; then
    echo "Usage: $0 <tenant-name>"
    exit 1
fi

# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace $NAMESPACE

# æ ‡è®°å‘½åç©ºé—´å¯ç”¨ Istio æ³¨å…¥
kubectl label namespace $NAMESPACE istio-injection=enabled

# åˆ›å»ºç§Ÿæˆ·ä¸“ç”¨çš„ Gateway
cat <<EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: ${TENANT_NAME}-gateway
  namespace: $NAMESPACE
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*.${TENANT_NAME}.sealos.io"
    - "${TENANT_NAME}.sealos.io"
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "*.${TENANT_NAME}.sealos.io"
    - "${TENANT_NAME}.sealos.io"
    tls:
      mode: SIMPLE
      credentialName: ${TENANT_NAME}-tls-cert
EOF

# åˆ›å»ºå‘½åç©ºé—´å†…çš„æµé‡ç­–ç•¥
cat <<EOF | kubectl apply -f -
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-same-namespace
  namespace: $NAMESPACE
spec:
  action: ALLOW
  rules:
  - from:
    - source:
        namespaces: ["$NAMESPACE"]
  - from:
    - source:
        namespaces: ["istio-system"]
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-ingress-gateway
  namespace: $NAMESPACE
spec:
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"]
EOF

# åº”ç”¨èµ„æºé…é¢ï¼ˆå¯é€‰ï¼‰
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ResourceQuota
metadata:
  name: ${TENANT_NAME}-quota
  namespace: $NAMESPACE
spec:
  hard:
    requests.cpu: "10"
    requests.memory: 20Gi
    persistentvolumeclaims: "10"
    services.loadbalancers: "0"  # ç¦æ­¢ç§Ÿæˆ·åˆ›å»º LoadBalancer
EOF

echo "Tenant namespace $NAMESPACE created successfully!"
```

ä½¿ç”¨è„šæœ¬åˆ›å»ºæµ‹è¯•ç§Ÿæˆ·ï¼š

```bash
chmod +x create-tenant-namespace.sh
./create-tenant-namespace.sh user1
./create-tenant-namespace.sh user2
```

## 3. éªŒè¯ Istio ä¸ç°æœ‰ç»„ä»¶å…¼å®¹æ€§

### 3.1 æµ‹è¯•ä¸ç°æœ‰ CRD çš„å…¼å®¹æ€§

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰å†²çªçš„ CRD
kubectl get crd | grep -E "(virtualservice|gateway|destinationrule)"

# åˆ—å‡ºç°æœ‰çš„ webhook é…ç½®
kubectl get validatingwebhookconfigurations
kubectl get mutatingwebhookconfigurations

# ç¡®ä¿æ²¡æœ‰ç«¯å£å†²çª
kubectl get svc -A | grep -E "(80|443|15000|15001|15006|15008|15020|15021|15090)"
```

### 3.2 æµ‹è¯•åŸºç¡€è¿é€šæ€§

åˆ›å»ºæµ‹è¯•åº”ç”¨ `test-app.yaml`ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: httpbin
  namespace: ns-user1
  labels:
    app: httpbin
spec:
  ports:
  - name: http
    port: 8000
    targetPort: 80
  selector:
    app: httpbin
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: httpbin
  namespace: ns-user1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: httpbin
  template:
    metadata:
      labels:
        app: httpbin
    spec:
      containers:
      - image: docker.io/kennethreitz/httpbin
        imagePullPolicy: IfNotPresent
        name: httpbin
        ports:
        - containerPort: 80
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: httpbin
  namespace: ns-user1
spec:
  hosts:
  - httpbin.user1.sealos.io
  gateways:
  - user1-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: httpbin
        port:
          number: 8000
```

éƒ¨ç½²å¹¶æµ‹è¯•ï¼š

```bash
# éƒ¨ç½²æµ‹è¯•åº”ç”¨
kubectl apply -f test-app.yaml

# è·å– Ingress Gateway çš„å¤–éƒ¨ IP
export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].port}')

# æµ‹è¯•è®¿é—®ï¼ˆéœ€è¦é…ç½® DNS æˆ–ä½¿ç”¨ curl çš„ --resolveï¼‰
curl -I -HHost:httpbin.user1.sealos.io http://$INGRESS_HOST:$INGRESS_PORT/status/200

# æŸ¥çœ‹ Envoy è®¿é—®æ—¥å¿—
kubectl logs -n istio-system -l istio=ingressgateway -c istio-proxy --tail=10
```

### 3.3 éªŒè¯ä¸ Sealos æ§åˆ¶å™¨çš„å…¼å®¹æ€§

```bash
# æ£€æŸ¥ Sealos æ§åˆ¶å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
kubectl get pods -n sealos-system

# åˆ›å»ºæµ‹è¯•ç”¨çš„ Terminal CR
cat <<EOF | kubectl apply -f -
apiVersion: terminal.sealos.io/v1
kind: Terminal
metadata:
  name: test-terminal
  namespace: ns-user1
spec:
  user: user1
  token: test-token
  apiServer: https://kubernetes.default.svc.cluster.local:443
EOF

# è§‚å¯Ÿæ§åˆ¶å™¨æ—¥å¿—ï¼Œç¡®ä¿æ²¡æœ‰é”™è¯¯
kubectl logs -n sealos-system -l app=terminal-controller --tail=20
```

## 4. æ€§èƒ½åŸºå‡†æµ‹è¯•

### 4.1 å®‰è£…æ€§èƒ½æµ‹è¯•å·¥å…·

```bash
# å®‰è£… fortioï¼ˆIstio å®˜æ–¹æ¨èçš„è´Ÿè½½æµ‹è¯•å·¥å…·ï¼‰
kubectl apply -f - <<EOF
apiVersion: v1
kind: Service
metadata:
  name: fortio
  namespace: istio-system
spec:
  ports:
  - port: 8080
    name: http
  selector:
    app: fortio
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fortio
  namespace: istio-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fortio
  template:
    metadata:
      labels:
        app: fortio
    spec:
      containers:
      - name: fortio
        image: fortio/fortio:latest
        ports:
        - containerPort: 8080
        args:
        - server
EOF
```

### 4.2 æ‰§è¡ŒåŸºå‡†æµ‹è¯•

```bash
# è¿›å…¥ fortio pod
kubectl exec -it -n istio-system deployment/fortio -- /bin/bash

# æµ‹è¯•æ—  Istio çš„æ€§èƒ½ï¼ˆç›´æ¥è®¿é—®æœåŠ¡ï¼‰
fortio load -c 10 -qps 1000 -t 30s http://httpbin.ns-user1:8000/status/200

# æµ‹è¯•é€šè¿‡ Istio Gateway çš„æ€§èƒ½
fortio load -c 10 -qps 1000 -t 30s -H "Host: httpbin.user1.sealos.io" http://istio-ingressgateway.istio-system/status/200

# è®°å½•å¹¶å¯¹æ¯”ç»“æœ
```

### 4.3 ç›‘æ§èµ„æºä½¿ç”¨

```bash
# ç›‘æ§ Istio ç»„ä»¶èµ„æºä½¿ç”¨
kubectl top pods -n istio-system

# ç›‘æ§ sidecar æ³¨å…¥åçš„åº”ç”¨èµ„æºä½¿ç”¨
kubectl top pods -n ns-user1

# æŸ¥çœ‹ Prometheus æŒ‡æ ‡ï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
kubectl port-forward -n istio-system svc/prometheus 9090:9090
# è®¿é—® http://localhost:9090ï¼ŒæŸ¥è¯¢ Istio ç›¸å…³æŒ‡æ ‡
```

## 5. æ•…éšœæ’æŸ¥å‘½ä»¤

```bash
# æ£€æŸ¥ Istio é…ç½®çŠ¶æ€
istioctl analyze --all-namespaces

# æŸ¥çœ‹ Envoy é…ç½®
istioctl proxy-config cluster -n ns-user1 deployment/httpbin
istioctl proxy-config route -n ns-user1 deployment/httpbin

# æŸ¥çœ‹ Envoy ç»Ÿè®¡ä¿¡æ¯
istioctl proxy-stats -n ns-user1 deployment/httpbin

# è°ƒè¯•æµé‡è·¯ç”±
istioctl x describe pod -n ns-user1 httpbin-xxx

# æ£€æŸ¥ mTLS çŠ¶æ€
istioctl authn tls-check -n ns-user1 httpbin.ns-user1.svc.cluster.local
```

## 6. æ¸…ç†æµ‹è¯•ç¯å¢ƒï¼ˆå¯é€‰ï¼‰

```bash
# åˆ é™¤æµ‹è¯•åº”ç”¨
kubectl delete -f test-app.yaml
kubectl delete namespace ns-user1 ns-user2

# å¸è½½ Istioï¼ˆè°¨æ…æ“ä½œï¼‰
istioctl uninstall --purge -y
kubectl delete namespace istio-system
```

## LoadBalancer é™åˆ¶å½±å“åˆ†æä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜è¯´æ˜

åœ¨ Istio è¿ç§»çš„ç§Ÿæˆ· ResourceQuota ä¸­**æ–°å¼•å…¥**äº† `services.loadbalancers: "0"` é™åˆ¶ï¼Œç¦æ­¢ç§Ÿæˆ·åˆ›å»º LoadBalancer ç±»å‹çš„æœåŠ¡ã€‚

**ğŸš¨ é‡è¦è¯´æ˜**ï¼šè¿™ä¸ªé™åˆ¶**ä¸æ˜¯**ç°æœ‰ Sealos çš„é»˜è®¤è¡Œä¸ºï¼Œè€Œæ˜¯ä¸“é—¨ä¸º Istio è¿ç§»ç¯å¢ƒè®¾è®¡çš„æ¶æ„çº¦æŸã€‚ç°æœ‰ç”Ÿäº§ç¯å¢ƒä¸­ç”¨æˆ·å¯ä»¥æ­£å¸¸åˆ›å»º LoadBalancer æœåŠ¡ã€‚

è¿™ä¸ªé™åˆ¶å¯¹ Sealos ç°æœ‰åŠŸèƒ½çš„å½±å“åˆ†æå¦‚ä¸‹ï¼š

### å½±å“è¯„ä¼°

| ç»„ä»¶ | å½“å‰å®ç° | æ˜¯å¦å—å½±å“ | è¯´æ˜ |
|------|----------|------------|------|
| DevBox | NodePort + Istio Gateway | âœ… æ— å½±å“ | å·²ä½¿ç”¨ NodePort æš´éœ² SSH ç­‰æœåŠ¡ |
| æ•°æ®åº“æœåŠ¡ | NodePort | âœ… æ— å½±å“ | é€šè¿‡ NodePort æä¾›å¤–éƒ¨è®¿é—® |
| ç”¨æˆ·åº”ç”¨ | NodePort + Istio Gateway | âœ… æ— å½±å“ | TCP ç«¯å£ç”¨ NodePortï¼ŒHTTP ç”¨ Istio |
| MinIO å¯¹è±¡å­˜å‚¨ | LoadBalancer | ğŸš¨ **å—å½±å“** | å”¯ä¸€ä½¿ç”¨ LoadBalancer çš„æœåŠ¡ |

### è§£å†³æ–¹æ¡ˆï¼šMinIO è¿ç§»åˆ° NodePort + Istio

**è‡ªåŠ¨åŒ–è¿ç§»è„šæœ¬ï¼ˆæ¨èï¼‰ï¼š**
```bash
# ä½¿ç”¨æä¾›çš„è‡ªåŠ¨åŒ–è„šæœ¬
./scripts/istio-migration/migrate-minio-to-nodeport.sh

# é¢„è§ˆè¿ç§»æ“ä½œ
./scripts/istio-migration/migrate-minio-to-nodeport.sh --dry-run

# è‡ªå®šä¹‰é…ç½®
./scripts/istio-migration/migrate-minio-to-nodeport.sh \
    --domain minio.sealos.io \
    --nodeport 31900
```

**æ‰‹åŠ¨é…ç½®æ–¹å¼ï¼š**
```bash
# 1. å¤‡ä»½å½“å‰é…ç½®
kubectl get service object-storage -n objectstorage-system -o yaml > minio-service-backup.yaml

# 2. åº”ç”¨æ–°çš„ NodePort + Istio é…ç½®
kubectl apply -f scripts/istio-migration/minio-istio-config.yaml

# 3. éªŒè¯è¿ç§»ç»“æœ
kubectl get service object-storage -n objectstorage-system
kubectl get gateway minio-gateway -n objectstorage-system
kubectl get virtualservice minio-vs -n objectstorage-system
```

**è¿ç§»åçš„è®¿é—®æ–¹å¼ï¼š**
- **HTTP/HTTPS**: `https://minio.objectstorage-system.sealos.io` (é€šè¿‡ Istio Gateway)
- **ç›´æ¥ TCP**: `http://<NODE_IP>:30900` (é€šè¿‡ NodePort)

### è¯¦ç»†æŠ€æœ¯åˆ†æ

å®Œæ•´çš„å½±å“åˆ†æå’Œè§£å†³æ–¹æ¡ˆè¯·å‚è€ƒï¼š[LoadBalancer é™åˆ¶å½±å“åˆ†æä¸è§£å†³æ–¹æ¡ˆ](./loadbalancer-impact-analysis.md)

## æ³¨æ„äº‹é¡¹

1. **èµ„æºéœ€æ±‚**ï¼šIstio ä¼šä¸ºæ¯ä¸ª Pod æ³¨å…¥ sidecar ä»£ç†ï¼Œé¢„è®¡æ¯ä¸ª Pod é¢å¤–éœ€è¦ 100MB å†…å­˜å’Œ 100m CPU
2. **ç½‘ç»œç­–ç•¥**ï¼šç¡®ä¿é›†ç¾¤ç½‘ç»œæ’ä»¶æ”¯æŒ NetworkPolicy
3. **LoadBalancer æ›¿ä»£**ï¼šç³»ç»Ÿè®¾è®¡å·²é€‚é… NodePort + Istio æ¶æ„ï¼Œå¯åœ¨æ—  LoadBalancer ç¯å¢ƒè¿è¡Œ
4. **DNS é…ç½®**ï¼šéœ€è¦é…ç½®é€šé…ç¬¦ DNS è®°å½•æŒ‡å‘ Istio Ingress Gateway çš„å¤–éƒ¨ IP
5. **è¯ä¹¦ç®¡ç†**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®é›†æˆ cert-manager è‡ªåŠ¨ç®¡ç† TLS è¯ä¹¦
6. **MinIO è¿ç§»**ï¼šå¦‚éƒ¨ç½²äº† MinIO å¯¹è±¡å­˜å‚¨ï¼Œéœ€è¦å…ˆæ‰§è¡Œ LoadBalancer åˆ° NodePort çš„è¿ç§»

## ä¸‹ä¸€æ­¥

å®Œæˆç¯å¢ƒå‡†å¤‡åï¼Œå¯ä»¥ç»§ç»­è¿›è¡Œï¼š
- 1.2 æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡
- 1.3 å·¥å…·å¼€å‘