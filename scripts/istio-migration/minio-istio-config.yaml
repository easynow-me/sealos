# MinIO NodePort + Istio Gateway 配置
# 用于替代 LoadBalancer 类型的 MinIO 服务

---
# MinIO NodePort 服务
apiVersion: v1
kind: Service
metadata:
  name: object-storage
  namespace: objectstorage-system
  labels:
    app: minio
    component: object-storage
spec:
  type: NodePort
  ports:
    - name: http-minio
      protocol: TCP
      port: 9000
      targetPort: 9000
      nodePort: 30900
  selector:
    v1.min.io/tenant: object-storage
  sessionAffinity: None
  externalTrafficPolicy: Cluster

---
# MinIO Istio Gateway
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: minio-gateway
  namespace: objectstorage-system
  labels:
    app: minio
    component: gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "minio.objectstorage-system.sealos.io"
    - "*.objectstorage-system.sealos.io"
    # HTTP 重定向到 HTTPS
    tls:
      httpsRedirect: true
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "minio.objectstorage-system.sealos.io"
    - "*.objectstorage-system.sealos.io"
    tls:
      mode: SIMPLE
      credentialName: minio-tls-cert

---
# MinIO VirtualService
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: minio-vs
  namespace: objectstorage-system
  labels:
    app: minio
    component: virtual-service
spec:
  hosts:
  - "minio.objectstorage-system.sealos.io"
  gateways:
  - minio-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: object-storage
        port:
          number: 9000
    timeout: 300s
    corsPolicy:
      allowOrigins:
      - regex: ".*"
      allowMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - HEAD
      - OPTIONS
      allowHeaders:
      - "*"
      allowCredentials: false
    headers:
      response:
        set:
          X-Frame-Options: "SAMEORIGIN"
          X-Content-Type-Options: "nosniff"
          X-XSS-Protection: "1; mode=block"

---
# MinIO TLS 证书 (可选，需要 cert-manager)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: minio-tls-cert
  namespace: objectstorage-system
spec:
  secretName: minio-tls-cert
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
  - "minio.objectstorage-system.sealos.io"